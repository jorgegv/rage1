# WORKFLOW FOR GAME MAP DESIGN WITH MAPGEN TOOL

Map screens in RAGE1 must currently be created manually: BTILES are defined
manually from PNG data, and then those BTILES must be manually placed on a
grid; this procedure must be done for each and all of the screens that form
the map of the game.

This is a tedious process, so a new tool and workflow has been designed so
that this procedure can be done in a quick and efficient way, and the most
boring stages can be automated. Initially, the tool and workflow must
support the following functionalities:

- BTILE positioning by copy/paste

- Automatic generation of GDATA files for each of the map screens

- Automatic HOTZONE creation (for screen switching)

## Requirements

- A graphical image editor (e.g.  GIMP) that has the following features:

  - Can show a configurable grid when editing an image; this is quite
  convenient for knowing the character cells that are so important in
  Spectrum graphic design

  - Can read and write PNG files

- A recent version of RAGE1 which includes the new MAPGEN tool, which is
  capable of reading a big PNG file with the whole map and output the
  required GDATA files with some configuration

- The game BTILES that are used to draw the map screens have already been
  drawn individually and are stored in one or more PNG files (several/all
  tiles can be stored in the same PNG file if desired), and they are aligned
  to Spectrum character cells (i.e.  8x8 pixel cells).  This makes selecting
  BTILES for copy/paste much easier when you activate the 8x8 grid.

The present document assumes that the graphical image editor used is GIMP.

## General Workflow

The way of working with GIMP for creating the map can be resumed in the
following points:

- The PNG file(s) where the BTILES are stored are opened in GIMP

- The GIMP grid is activated on all images and set to 8x8-pixel cells

- A big image is created for drawing, and initialized to color black.  This
  image will contain the whole game map.

  - The grid will also be activated on this image

  - On this image, only copy/paste from the other PNG image is allowed.  No
    manual editing is allowed, so that the MAPGEN tool can do its work
    without problems later

  - All copy/paste activity on this image must be strictly aligned to the
    8x8 grid

- The game screens are created by just copying/pasting from the original
  BTILE PNGs into the main map image: go to the PNG, select a BTILE (zoom in
  and use the grid for ensuring the correct tile is copied), copy it and
  then paste it in the main map (also ensuring correct grid alignment)

- This procedure can be done quite fast and can be repeated until the whole
  game map has been drawn.

- Once the map is drawn, the zones that allow switching from one screen to
  adjacent ones can also be drawn on the same map: rectangles filled in red
  (or any other special color?) shall be used, and can be placed anywhere on
  the map.  If the rectangle covers two different screens, the corresponding
  HOTZONEs will be created on each of the screens and and the needed FLOW
  rules generated to connect them reciprocally.

Finally, the main map will need to be exported to PNG format so that it can
be read by the MAPGEN tool described in the next section.

## MAPGEN Tool

MAPGEN is a tool that uses the main map generated with the workflow
described before, and the PNG files with the BTILES, and generates GDATA
files for all the individual screens in the map, including BTILE and HOTZONE
references.

Some assumptions:

- Screen dimensions and BTILE positioning are specified always in cell
  coords (_not_ pixel coords)

- The game screens are all the same size (R rows x C columns)

- The input data is all in PNG format

Input data:

- PNG file(s) with BTILE graphic data.  Each PNG BTILE file has an
  associated TILEDEF (.tiledef) file which indicates the name, position,
  size and default tile type (OBSTACLE, ITEM, DECORATION) for each of the
  BTILEs included in a given PNG file.

  TILEDEF files should be very easy to generate by hand when opening the PNG
  file and activating the grid).  A tiledef file is composed of lines with
  the following format, one line per BTILE (example):

  ```
  wall_2x4 2 3 2 4 obstacle
  ```

  The previous line would define a BTILE named `wall_2x4`, which is at row
  2, column 3, is 2 cells wide and 4 cells high, and has a default type of
  `OBSTACLE`.  All cell coordinates are zero-based.

  Comments are allowed, starting with the `#` char and up to the end of the
  line.  Blank lines are ignored.

- PNG main map, as generated by the previous workflow

- Screen dimensions in rows and columns (R and C values mentioned above)

Output:

- One GDATA file per screen, inside a given output directory

- Each GDATA contains all BTILES that form the screen, HOTZONE definitions
  (which connect to adjacent screens) and positioning data for all items of
  both types

Remarks:

- Only non-empty screens are generated.  Even if the map is MxN screens in
  size, empty screens will not be generated

### MAPGEN design hints

The main map will be processed in 8x8 cells.

At the start, a dictionary of BTILEs is created so that they can be
identified quickly when processing the main map:

- The BTILES are read from the PNG and TILEDEF files

- A hash for each 8x8 cell of a BTILE is generated for easier searching

- Each BTILE has a list of the hashes of its cells (direct index)

- Each hash has a list of the BTILEs that have that cell (reverse index)

After all BTILEs have been read and processed, the main map is processed:

- The main map dimensions must be a multiple of the R*8 and C*8 values
  (cells to pixels).  This is checked at the beginning and the main map is
  rejected if it does not meets this requirement

- The main map is processed in 8x8 cells and hashes for each of the cells
  are calculated and stored for each position in the map.

- The map is then processed in blocks of R x C cells (map screens)

- Inside each of those blocks: for each cell, the cell hash is matched
  against the BTILE hash reverse dictionary, and all candidate BTILEs for
  that cell are found.

- With this method, BTILEs can be identified and their names and positions
  added to the list of BTILES for the current screen

- Also, a flag for "successfully identified" cells should be noted, so that
  at the end of the process, if all cells have been identified, the screen
  can be considered a success, and otherwise report that some of the BTILEs
  could not be identified. Similar code to that of the SCREEN definition
  with digraphs, etc.

