# FLOWGEN

Flowgen is a utility for compiling game scripts into code that can be
included in your game. The executable is `tools/flowgen.pl`. You need Perl
for running it.

Code generated by Flowgen is intended to be run from the check_game_flags()
function which is part of the main game loop, and from several other places.

## Basic design

* All code generated by Flowgen is configured with rules based on the
  pattern WHEN-CHECK-DO

* All rules are assigned to one or more map_screens (from now on, "screens")

* Only the rules for the current screen are executed, for performance
  reasons

* Each screen has its own lists of rules that are executed at different
  moments in the game loop. Think of these lists as "hooks" for each screen
  to be called at certain times.

* For optimizing rule storage, there is a global rule table where each rule
  is defined but with no screen information. Then, each screen has
  several tables of pointers to rules to be executed at each moment. The
  different moments are identified by the WHEN clauses in the rules

* When a new "WHEN" moment is identified (that is: when we identify a new
  condition in the game loop where it would be interesting to execute
  hooks), we should define a new table in the flow_rules element of the
  map_screen_s struct (see below for the places already identified).

* The code at different points in the game loop only activates and
  deactivates game flags

* These game flags are processed and acted upon in check_game_flags()
  function. Most processing must take place here. There may be some reactions
  that may be executed at the place of detection (?)

* Before executing check_game_flags(), the function run_flow_rules() should
  be executed. This function checks and executes the FLOWGEN rules, it is
  the main loop of the scripting engine, and all FLOWGEN code is executed
  here

* A separate field `user_flags`, analogous to `game_flags`, exists in
  `game_state` structure. This user flags can be manipulated through FLOWGEN
  rules

* An additional field `loop_flags` exists in `game_state` structure. This
  field contains flags for checks that are run during each iteration of the
  game loop, and that must be processed later. All loop flags are reset at
  the beginning of each run of the game loop.

* FLOWGEN rules can check game flags and loop flags (but can not modify
  them), and can check and modify user flags.

## Rule design

All rules follow the pattern:

`[WHEN_TO_RUN] [WHAT_TO_CHECK] [ACTION_TO_EXECUTE]`

* WHEN_TO_RUN: the point where the rule is checked and action executed if
check is successful. Options: 
  - [x] ENTER_SCREEN
  - [x] EXIT_SCREEN
  - [x] GAME_LOOP

* WHAT_TO_CHECK: the condition to check. Options:
  - [x] GAME_FLAG_IS_SET <flag>
  - [x] GAME_FLAG_IS_RESET <flag>
  - [x] LOOP_FLAG_IS_SET <flag>
  - [x] LOOP_FLAG_IS_RESET <flag>
  - [x] USER_FLAG_IS_SET <flag>
  - [x] USER_FLAG_IS_RESET <flag>
  - [ ] ITEM_IS_OWNED <item>
  - [ ] LIVES <comparison> <value>
  - [ ] ENEMIES_ALIVE <comparison> <value>

* ACTION_TO_EXECUTE:
  - [x] SET_USER_FLAG <flag>
  - [x] RESET_USER_FLAG <flag>
  - [x] INC_LIVES <num_lives>
  - [x] PLAY_SOUND <fxid>
  - [ ] ENABLE_TILE <tile_name>
  - [ ] DISABLE_TILE <tile_name>
  - [ ] ENABLE_HOTZONE <hotzone_name>
  - [ ] DISABLE_HOTZONE <hotzone_name>

## FLOWGEN Gdata file syntax

The data files for FLOWGEN rules are also in GDATA format.

Example FLOWGEN data file:

```
BEGIN_RULE
        SCREEN  Screen01
        WHEN    GAME_LOOP
        CHECK   LOOP_FLAG_IS_SET F_LOOP_ENEMY_HIT
	(...)
        DO      SET_USER_FLAG 0x0001
        DO      INC_LIVES 0x0001
END_RULE
```

Syntax:

* `BEGIN_RULE` and `END_RULE`: start and end of a rule definition

* `SCREEN`: mandatory. Specifies what screen this rule must be run on

* `WHEN`: mandatory.  Specifies when this rule must be run.  See previous
  section for valid values.  For `GAME_LOOP`: the rule will be checked on
  every iteration of the game loop.  Be careful with rules in this table,
  they may heavily affect performance of the game

* `CHECK`: specifies a condition to be checked.  See previous section for
  valid values.  There must be at least one `CHECK` and there may be more
  than one.  All the checks will be run in order and their results ANDed to
  get the final check result. Short circuit evaluation is used here, so put
  first the rules that are more probable to give a false result

* `DO`: specifies an action to be run if all the `CHECK` conditions in this
  rule are true. There must be at least one `DO` and there may be more than
  one. All the actions will be eecuted in order.
