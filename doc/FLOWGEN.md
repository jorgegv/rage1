# FLOWGEN

Flowgen is a utility for compiling game scripts into code that can be
included in your game. The executable is `tools/flowgen.pl`. You need Perl
for running it.

Code generated by Flowgen is intended to be run from the check_game_flags()
function which is part of the main game loop, and from several other places.

## Basic design

* All code generated by Flowgen is configured with rules based on the
  pattern WHEN-CHECK-DO
* All rules are assigned to one or more map_screens (from now on, "screens")
* Only the rules for the current screen are executed, for performance
  reasons
* Each screen has its own lists of rules that are executed at different
  moments in the game loop. Think of these lists as "hooks" for each screen
  to be called at certain times.
* For optimizing rule storage, there is a global rule table where each rule
  is defined but with no screen information. Then, each screen has
  several tables of pointers to rules to be executed at each moment. The
  different moments are identified by the WHEN clauses in the rules
* When a new "WHEN" moment is identified (that is: when we identify a new
  condition in the game loop where it would be interesting to execute
  hooks), we should define a new table in the flow_rules element of the
  map_screen_s struct (see below for the places already identified).
* The code at different points in the game loop only activates and
  deactivates game flags
* These game flags are processed and acted upon in check_game_flags()
  function. Most processing must take place here. There may be some reactions
  that may be executed at the place of detection (?)
* Before executing check_game_flags(), the function run_flow_rules() should
  be executed. This function checks and executes the FLOWGEN rules, it is
  the main loop of the scripting engine, and all FLOWGEN code is executed
  here
* A separate field `user_flags`, analogous to `game_flags`, must exist in
  `game_state` structure. This user flags can be manipulated through FLOWGEN
  rules
* FLOWGEN rules can check game flags (but can not modify them), and can check
and modify user flags.

## Rule design

All rules follow the pattern:

`[WHEN_TO_RUN] [WHAT_TO_CHECK] [ACTION_TO_EXECUTE]`

* WHEN_TO_RUN: the point where the rule is checked and action executed if
check is successful. Options: 
  - [ ] WHEN_ENTER_SCREEN
  - [ ] WHEN_EXIT_SCREEN
  - [ ] WHEN_GAME_LOOP

* WHAT_TO_CHECK: the condition to check. Options:
  - [ ] CHECK_GAME_FLAG_IS_SET <flag>
  - [ ] CHECK_GAME_FLAG_IS_RESET <flag>
  - [ ] CHECK_USER_FLAG_IS_SET <flag>
  - [ ] CHECK_USER_FLAG_IS_RESET <flag>
  - [ ] CHECK_ITEM_IS_OWNED <item>
  - [ ] CHECK_LIVES <comparison> <value>
  - [ ] CHECK_ENEMIES_ALIVE <comparison> <value>

* ACTION_TO_EXECUTE:
  - [ ] DO_SET_USER_FLAG <flag>
  - [ ] DO_RESET_USER_FLAG <flag>
  - [ ] DO_INC_LIVES
  - [ ] DO_DEC_LIVES
  - [ ] DO_GOTO_SCREEN <index>
  - [ ] DO_BEEPFX <fxid>
